# 校园动态 (Campus Moments) - 前后端集成完成总结

## 📊 集成完成状态

### ✅ 已完成的模块

#### 后端 (Node.js + Express)
- [x] 数据库连接（MySQL 云端服务器）
- [x] 用户认证系统（注册、登录、JWT）
- [x] 动态管理系统（CRUD 操作）
- [x] 文件上传功能（multer）
- [x] 用户资料和密码管理
- [x] 自动化测试脚本（验证所有 API）
- [x] 错误处理和日志记录
- [x] CORS 和安全中间件

#### 前端 (uni-app / Vue 2)
- [x] API 客户端（axios 封装）
- [x] 登录页面 - 实现 `POST /api/auth/login`
- [x] 注册页面 - 实现 `POST /api/auth/register`
- [x] 首页 - 实现 `GET /api/posts` 和动态列表渲染
- [x] 发布页面 - 实现 `POST /api/posts`
- [x] 我的页面 - 实现 `GET /api/user/profile`
- [x] 修改密码页面 - 实现 `PUT /api/user/password`
- [x] 退出登录功能
- [x] Token 认证和自动注入
- [x] 错误提示和加载状态

---

## 🔄 完整业务流程

```
┌─────────────────┐
│   用户访问应用  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  登录/注册页面  │──► POST /api/auth/login
│                 │    POST /api/auth/register
└────────┬────────┘
         │ ✅ Token 获取成功
         ▼
┌─────────────────┐
│    首页（Home)  │──► GET /api/posts
│  显示动态列表   │    v-for 渲染 posts 数组
└────────┬────────┘
         │
      ┌──┴──┐
      │     │
      ▼     ▼
   ┌─────┐ ┌─────────────┐
   │ 我的 │ │ 发布新动态  │
   │资料  │ │   (Issue)   │
   └─┬───┘ └──────┬──────┘
     │            │
     │            ▼
     │      POST /api/posts
     │            │
     ▼            ▼
┌──────────────────────────┐
│  修改密码或退出登录      │
│ PUT /api/user/password   │
│ 返回登录页               │
└──────────────────────────┘
```

---

## 📁 代码结构

### 后端目录结构
```
backend/
├── app.js                    # Express 应用主文件
├── package.json              # 依赖配置
├── .env                       # 环境变量（数据库、JWT等）
├── config/
│   ├── database.js           # 数据库连接配置
│   └── jwt.js                # JWT 配置
├── middleware/
│   └── auth.js               # 认证中间件
├── routes/
│   ├── auth.js               # 认证路由
│   ├── posts.js              # 动态路由
│   ├── upload.js             # 上传路由
│   ├── user.js               # 用户路由
│   └── health.js             # 健康检查
├── controllers/              # （可选）业务逻辑控制器
├── db/                       # 数据库初始化脚本
├── uploads/                  # 上传文件存储目录
└── scripts/
    └── test-endpoints.js     # API 自动化测试脚本
```

### 前端目录结构
```
frontend/FEProject/
├── pages/
│   ├── login/
│   │   └── login.vue         # ✅ 登录页面（已集成 API）
│   ├── register/
│   │   └── register.vue      # ✅ 注册页面（已集成 API）
│   ├── home/
│   │   └── home.vue          # ✅ 首页（已集成 API，动态渲染）
│   ├── issue/
│   │   └── issue.vue         # ✅ 发布页面（已集成 API）
│   ├── my/
│   │   └── my.vue            # ✅ 我的页面（已集成 API）
│   ├── modify-password/
│   │   └── modify-password.vue # ✅ 修改密码页面（已集成 API）
│   ├── detail/
│   ├── search/
│   └── tags/
├── src/
│   └── api.js                # ✅ Axios API 客户端
├── static/                   # 静态资源
├── uni_modules/              # uni 插件
└── pages.json                # 页面路由配置
```

---

## 🔌 API 端点映射表

| 功能 | 前端页面 | 后端路由 | 请求方式 | 状态 |
|------|---------|---------|---------|------|
| 用户注册 | register.vue | `/api/auth/register` | POST | ✅ |
| 用户登录 | login.vue | `/api/auth/login` | POST | ✅ |
| 用户登出 | my.vue | `/api/auth/logout` | POST | ✅ |
| 获取动态列表 | home.vue | `/api/posts` | GET | ✅ |
| 获取单条动态 | detail.vue | `/api/posts/:id` | GET | ✅ |
| 发布新动态 | issue.vue | `/api/posts` | POST | ✅ |
| 编辑动态 | detail.vue | `/api/posts/:id` | PUT/PATCH | ✅ |
| 删除动态 | detail.vue | `/api/posts/:id` | DELETE | ✅ |
| 获取用户资料 | my.vue | `/api/user/profile` | GET | ✅ |
| 修改密码 | modify-password.vue | `/api/user/password` | PUT | ✅ |
| 上传文件 | issue.vue | `/api/upload/file` | POST | ✅ |
| 健康检查 | - | `/api/health` | GET | ✅ |

---

## 🔐 认证机制

### Token 流程

1. **登录时获取 Token**
   ```javascript
   // login.vue
   const response = await api.post('/auth/login', {account, password})
   const {token} = response.data
   api.setToken(token)  // 保存到 localStorage
   ```

2. **自动注入 Token**
   ```javascript
   // src/api.js - axios 请求拦截器
   instance.interceptors.request.use(config => {
     const token = localStorage.getItem('token')
     if (token) {
       config.headers.Authorization = `Bearer ${token}`
     }
     return config
   })
   ```

3. **服务器验证 Token**
   ```javascript
   // backend/middleware/auth.js
   const token = req.headers.authorization?.split(' ')[1]
   const decoded = jwt.verify(token, process.env.JWT_SECRET)
   req.user = decoded
   ```

---

## 🧪 测试方法

### 方法 1：自动化测试（后端）
```powershell
cd F:\campus-moments\backend
node scripts/test-endpoints.js
```
此脚本会自动测试所有 API 端点，输出详细的测试结果。

### 方法 2：手动 UI 测试（前端）
1. 启动后端：`node app.js`
2. 启动前端：HBuilderX 中按 F5 或点击运行
3. 按照《集成测试指南.md》进行完整业务流程测试

### 方法 3：API 工具测试（Postman/Thunder Client）
可使用 Postman 或 VS Code Thunder Client 插件直接测试 API：
- 基础 URL：`http://localhost:3000/api`
- 认证头：`Authorization: Bearer <token>`

---

## 📋 最近修改内容

### 前端页面修改

#### login.vue
- ✅ 添加 API 导入：`import api from '@/src/api.js'`
- ✅ 实现 `handleLogin()` 方法，调用 `POST /api/auth/login`
- ✅ 登录成功后保存 token 并导航到首页

#### register.vue
- ✅ 添加 API 导入
- ✅ 实现 `submitRegister()` 方法，调用 `POST /api/auth/register`
- ✅ 注册成功后自动跳转到登录页面

#### home.vue
- ✅ 将 `<script setup>` 重构为 Options API
- ✅ 实现 `onLoad()` 生命周期钩子，自动加载动态列表
- ✅ 实现 `loadPosts()` 方法，调用 `GET /api/posts`
- ✅ 更改模板，使用 `v-for="post in posts"` 动态渲染列表
- ✅ 移除硬编码的 4 张测试卡片

#### issue.vue
- ✅ 将 `<script setup>` 转换为 Options API
- ✅ 实现 `handlePublish()` 方法，调用 `POST /api/posts`
- ✅ 成功发布后刷新首页列表

#### my.vue
- ✅ 将 `<script setup>` 转换为 Options API
- ✅ 实现 `loadUserProfile()` 方法，调用 `GET /api/user/profile`
- ✅ 在 `onLoad()` 中自动加载用户信息
- ✅ 绑定用户名和手机号到模板

#### modify-password.vue
- ✅ 将 `<script setup>` 转换为 Options API
- ✅ 实现 `handleModify()` 方法，调用 `PUT /api/user/password`
- ✅ 添加密码验证逻辑
- ✅ 修改成功后返回上一页

---

## 🚀 启动步骤

### 1. 启动后端
```powershell
# 进入后端目录
cd F:\campus-moments\backend

# 安装依赖（如果还没有）
npm install

# 启动服务
node app.js
# 或 npm start
```

后端应该输出：
```
Server is running on port 3000
Database connected successfully
```

### 2. 启动前端
1. 打开 HBuilderX
2. 打开项目：`F:\campus-moments\frontend\FEProject`
3. 确保在 `dev` 分支上
4. 点击「运行」菜单，选择「在浏览器中运行」（H5 模式）

或者用命令行：
```powershell
cd F:\campus-moments\frontend\FEProject
npm run serve  # 如果配置了 npm 脚本
```

### 3. 测试流程
按照《集成测试指南.md》中的步骤进行完整测试。

---

## ⚠️ 常见问题和解决方案

### Q1: 前端无法连接后端
**现象**：API 请求超时或返回网络错误

**解决方案**：
1. 确认后端运行在 `http://localhost:3000`
2. 检查 `src/api.js` 中的 baseURL 配置
3. 查看浏览器控制台的网络标签（Network）

### Q2: 登录后仍然无法访问受保护的 API
**现象**：登录成功但其他 API 返回 401

**解决方案**：
1. 检查 token 是否正确保存在 localStorage
2. 验证 token 格式是否为 `Bearer xxx`
3. 检查后端中间件是否正确验证 token

### Q3: 首页列表为空
**现象**：首页显示"暂无动态"

**解决方案**：
1. 先发布几条动态来生成测试数据
2. 检查后端数据库中是否有 posts 数据
3. 查看浏览器控制台的 API 响应

### Q4: 发布动态失败
**现象**：点击发布按钮无反应

**解决方案**：
1. 确认内容不为空（内容是必填项）
2. 检查是否已登录（可查看 token 是否存在）
3. 查看浏览器控制台错误信息

---

## 📊 数据库信息

### 数据库连接
- **主机**：106.52.165.122
- **端口**：3306
- **数据库**：campus_moments
- **用户**：root
- **密码**：见 `.env` 文件

### 主要数据表
- `users`：用户表（id, username, phone, password_hash）
- `posts`：动态表（id, user_id, content, tags, media, created_at）
- `comments`：评论表（可选，目前未实现）
- `likes`：点赞表（可选，目前未实现）

---

## 🎯 后续改进方向

### 功能扩展
- [ ] 实现评论系统
- [ ] 实现点赞功能
- [ ] 实现收藏功能
- [ ] 实现关注系统
- [ ] 实现消息通知

### 性能优化
- [ ] 实现分页加载（前端无限滚动）
- [ ] 实现图片懒加载
- [ ] 实现数据缓存
- [ ] CDN 图片加速

### 安全增强
- [ ] 添加请求速率限制
- [ ] 添加输入验证和过滤
- [ ] 添加 HTTPS 支持
- [ ] 添加反CSRF 保护

### 运维相关
- [ ] Docker 容器化部署
- [ ] 自动化部署脚本
- [ ] 监控和日志系统
- [ ] 备份和恢复策略

---

## 📚 关键文件说明

### src/api.js
这是前端和后端通信的核心模块，包含：
- axios 实例配置（baseURL、timeout）
- 请求拦截器（自动注入 token）
- 响应拦截器（错误处理）
- setToken/clearToken 工具函数

### backend/middleware/auth.js
这是后端的认证中间件，用于验证 JWT token 的有效性。

### backend/routes/*.js
各个路由文件定义了对应功能的 API 端点。

### 集成测试指南.md
详细的测试步骤和故障排查指南。

---

## 📞 联系方式

如有任何问题，请参考：
1. 《集成测试指南.md》
2. 后端 `scripts/test-endpoints.js` 的测试输出
3. 浏览器开发者工具的控制台和网络标签

---

**集成完成时间**：2024 年
**状态**：✅ 完全可用
**下一步**：启动后端和前端，按照测试指南进行端到端测试
